<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Feuillets du Livre d'Or - Abb√© Patrick Muswankeng</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@300;400;700&family=Sacramento&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>

    <script>
        // Configuration Tailwind adapt√©e au Th√®me Solennel (Bleu/Or)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-navy': '#002D62',       /* Bleu Marine Solennel */
                        'accent-gold': '#FFD700',        /* Or Accent */
                        'bg-paper': '#fffcf8',           /* Fond de page l√©ger */
                    },
                    fontFamily: {
                        'serif': ['Merriweather', 'serif'],
                        'display': ['Playfair Display', 'serif'],
                        'sacramento': ['Sacramento', 'cursive'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Variables CSS (Adapt√©es au Bleu/Or) */
        :root {
            --primary-color: #002D62;
            --accent-color: #DAA520; /* J'ai uniformis√© l'Or pour qu'il soit plus riche */
            --fond: #fffcf8;
            --fond-secondaire: #f0f4f7;
            --texte: #3c3c3c;
        }

        body {
            font-family: theme('fontFamily.serif');
            background: linear-gradient(135deg, var(--fond), var(--fond-secondaire));
            color: var(--texte);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        main {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
            flex-grow: 1;
        }

        /* --- STYLES G√âN√âRAUX --- */
        .main-title {
            color: var(--primary-color);
            font-family: theme('fontFamily.display');
            letter-spacing: 3px;
            text-shadow: 2px 3px 5px rgba(0,0,0,0.1); 
            font-weight: 700;
        }
        
        .intro-quote {
            max-width: 700px;
            margin: 30px auto 40px auto;
            font-family: theme('fontFamily.serif');
            font-size: 1.5rem;
            line-height: 1.8;
            color: #555;
            border-left: 5px solid var(--accent-color);
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.7); 
            border-radius: 5px;
            font-style: italic;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* --- CAROUSEL AM√âLIOR√â --- */
        .carousel-container {
            width: 100%;
            overflow: hidden;
            position: relative;
            height: 300px; 
            margin-bottom: 30px;
            border: 5px solid var(--primary-color);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .carousel-track {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.6s ease-in-out;
        }

        .carousel-slide {
            min-width: 100%;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        /* --- Animation d'entr√©e des messages --- */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-message {
            animation: fade-in-up 0.5s ease-out forwards;
            opacity: 0; 
        }
        
        /* --- Cartes de messages (Feuillets de Livre) --- */
        .testimonial-card {
            background: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
            text-align: left;
            position: relative;
            border: 1px solid #e0e0e0; 
            border-left: 10px solid var(--primary-color);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .testimonial-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }
        
        .testimonial-name {
            font-family: theme('fontFamily.display');
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
            padding-left: 0; 
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--accent-color);
        }
        
        .testimonial-message {
            font-size: 1.15em;
            line-height: 1.7;
            margin-top: 20px;
            padding-left: 0;
            color: #444;
            font-style: italic;
        }
        
        /* --- Signature Manuscrite --- */
        .testimonial-signature {
            display: block;
            text-align: right;
            font-family: theme('fontFamily.sacramento'); 
            font-size: 2.5rem; 
            color: var(--primary-color);
            line-height: 1;
        }

        .testimonial-date {
            font-size: 0.9rem;
            color: #777; /* Rendre la date un peu plus visible */
            font-style: normal; 
            display: block;
            text-align: right;
            margin-top: 5px;
        }

        /* --- Styles Boutons de Tri --- */
        .filter-btn {
            @apply px-5 py-2 text-base font-semibold rounded-full transition-colors duration-200;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
        }

        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 45, 98, 0.4);
        }
        
        /* --- Styles des Boutons de R√©actions --- */
        .reaction-btn {
            @apply flex items-center p-1.5 rounded-full transition-all duration-200
                     border border-gray-200 bg-white hover:bg-accent-gold/20;
            cursor: pointer;
            line-height: 1;
            user-select: none;
        }
        
        .reaction-count {
            @apply text-sm font-bold text-primary-navy/90 ml-1; 
        }
        
        .reaction-btn:disabled, .reacted {
            opacity: 0.8; /* Rendre l√©g√®rement plus opaque */
            cursor: default;
            background-color: #f0f4f7 !important; 
        }
        
        /* --- FOOTER AM√âLIOR√â --- */
        footer {
            margin-top: 50px;
            padding: 20px;
            background-color: var(--primary-color); 
            color: white;
            text-align: center;
            font-size: 0.9rem;
            width: 100%;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2);
        }
        footer .designer-signature {
            font-family: theme('fontFamily.sacramento'); 
            font-size: 1.5rem; 
            color: theme('colors.accent-gold'); 
            font-weight: bold;
        }
        
        /* --- Styles d'impression pour cacher les √©l√©ments interactifs --- */
        @media print {
            .no-print, header, footer { /* AJOUT du footer ici */
                display: none !important;
            }
            body {
                background: #ffffff !important;
                padding: 0;
            }
            main {
                max-width: none;
                padding: 0;
            }
            .testimonial-card {
                box-shadow: none;
                border: 1px solid #ccc; 
                break-inside: avoid; 
                page-break-inside: avoid;
            }
            /* Simplifier l'affichage du nom/date pour l'impression */
            .only-print .testimonial-date {
                margin-top: 15px;
                color: #555;
            }
            .only-print .testimonial-signature {
                font-size: 1.8rem;
                color: black;
            }
        }

    </style>
</head>

<body>
    <header class="no-print">
        <div class="h-5 bg-primary-navy"></div>
    </header>

    <main>
        
        <div class="carousel-container no-print">
            <div class="carousel-track" id="carouselTrack">
                <div class="carousel-slide"><img src="photo8.jpeg" alt="Photo de l'Abb√© Patrick Muswankeng 1"></div>
                <div class="carousel-slide"><img src="photo9.jpeg" alt="Photo de l'Abb√© Patrick Muswankeng 2"></div>
                <div class="carousel-slide"><img src="photo10.jpeg" alt="Photo de l'Abb√© Patrick Muswankeng 3"></div>
            </div>
            </div>

        <h1 class="main-title text-5xl lg:text-6xl text-center mt-12 mb-2 font-extrabold tracking-widest">
            <span class="text-accent-gold text-7xl mr-2">‚òß</span> Feuillets du Livre d'Or
        </h1>
        
        <p id="messageCount" class="text-xl font-display text-gray-700 mb-8 font-bold">
            <span class="text-4xl text-primary-navy font-extrabold" id="countValue">0</span> messages enregistr√©s pour l'Abb√© üìú
        </p>

        <blockquote class="intro-quote">
            ¬´ La plus grande b√©n√©diction de notre minist√®re est le souvenir que nous laissons dans le c≈ìur des fid√®les. Feuilletons ces marques d'amour et de pri√®re. ¬ª
        </blockquote>

        <div class="no-print flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-5 mb-10">
            <span class="text-lg font-bold text-primary-navy">Trier par :</span>
            <button id="sortByDate" class="filter-btn active" data-sort="date" aria-label="Trier par les messages les plus r√©cents">
                <span class="mr-2">üïí</span> R√©cents
            </button>
            <button id="sortByPopularity" class="filter-btn" data-sort="popularity" aria-label="Trier par les messages les plus populaires (nombre de coeurs)">
                <span class="mr-2">‚ù§Ô∏è</span> Les plus aim√©s
            </button>
        </div>

        <section id="testimonialsContainer" class="mt-8">
             </section>

        <div class="no-print flex flex-col items-center justify-center pt-8 pb-16">
            
            <button id="printButton" class="action-button" onclick="window.print()" style="background: linear-gradient(135deg, #4CAF50, #008000);">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v-2a2 2 0 012-2h4a2 2 0 012 2v2m-5 0h2m-7.5 0h3"></path></svg>
                Imprimer le livre
            </button>
            
            <a href="index.html" id="returnButton" class="action-button" style="background: linear-gradient(135deg, var(--primary-color), #0047AB);">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                Retourner √† la page d'accueil
            </a>
        </div>

    </main>

    <footer>
        <span class="text-gray-300">--- Un projet d√©velopp√© par <span class="designer-signature">Gabby Umba</span> 2025 ---</span>
    </footer>


    <script>
        // Cl√©s Firebase (√Ä mettre √† jour avec les v√¥tres)
        const firebaseConfig = {
            apiKey: "AIzaSyDT_tJG17ox5JChrj8Khw_yltdpaJxeJc4",
            authDomain: "abbepatrick-fe5db.firebaseapp.com",
            projectId: "abbepatrick-fe5db",
            storageBucket: "abbepatrick-fe5db.firebasestorage.app",
            messagingSenderId: "564527267199",
            appId: "1:564527267199:web:1645bd144ef9f4c0386e4a"
        };
        const appId = firebaseConfig.projectId;

        // Initialisation Firebase
        let app = null;
        let db = null;
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialis√© avec succ√®s.");
        } catch (error) {
            console.error("Erreur d'initialisation de Firebase.", error);
        }

        // R√©f√©rences DOM
        const container = document.getElementById('testimonialsContainer');
        const countValue = document.getElementById('countValue');
        const collectionPath = `artifacts/${appId}/public/data/testimonials`;
        let currentSort = 'date'; // Tri par d√©faut
        
        // Cl√© pour localStorage, emp√™che les clics multiples de l'utilisateur
        const REACTION_KEY = 'reactedMessages'; 

        // FONCTIONS DE GESTION LOCALSTORAGE (Conserv√©es)
        const getReactedIds = () => {
            try {
                const stored = localStorage.getItem(REACTION_KEY);
                return new Set(stored ? JSON.parse(stored) : []);
            } catch (e) {
                console.error("Erreur de lecture de localStorage:", e);
                return new Set();
            }
        };
        const addReactedId = (docId) => {
            try {
                const reactedIds = getReactedIds();
                reactedIds.add(docId);
                localStorage.setItem(REACTION_KEY, JSON.stringify([...reactedIds]));
            } catch (e) {
                console.error("Erreur d'√©criture de localStorage:", e);
            }
        };

        // Fonction de formatage de la date (J/M/A)
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'Date non enregistr√©e';
            const date = timestamp.toDate();
            // Utiliser des options compl√®tes pour un style solennel
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long', // Afficher le mois en toutes lettres
                year: 'numeric'
            });
        };

        // LOGIQUE DES R√âACTIONS (Conserv√©e)
        const handleReaction = async (docId, reactionType, button) => {
            if (!db || button.disabled) return;
            
            const reactedIds = getReactedIds();
            if (reactedIds.has(docId)) {
                console.warn("L'utilisateur a d√©j√† r√©agi √† ce message.");
                button.disabled = true; 
                return;
            }
            
            button.disabled = true; 
            button.classList.add('reacted');

            const docRef = db.collection(collectionPath).doc(docId);
            
            try {
                await docRef.update({
                    [`reactions.${reactionType}`]: firebase.firestore.FieldValue.increment(1),
                    totalReactions: firebase.firestore.FieldValue.increment(1) 
                });

                const countElement = button.querySelector('.reaction-count');
                if (countElement) {
                    const currentCount = parseInt(countElement.textContent) || 0;
                    countElement.textContent = currentCount + 1;
                }
                
                addReactedId(docId);

            } catch (error) {
                console.error(`Erreur lors de la r√©action (${reactionType}):`, error);
                button.disabled = false;
                button.classList.remove('reacted');
            }
        };

        // Fonction pour charger et afficher les messages (avec tri)
        const loadTestimonials = async () => {
            if (!db) {
                container.innerHTML = `<div class="mt-16 p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg" role="alert"><p class="text-xl font-bold font-display">‚ùå Erreur: Base de donn√©es non connect√©e.</p><p class="mt-2">Veuillez v√©rifier vos cl√©s Firebase dans le script.</p></div>`;
                countValue.textContent = 'Erreur';
                return;
            }

            container.innerHTML = '<p class="text-2xl text-primary-navy/70 mt-16 font-display">Chargement des feuillets... ‚è≥</p>';
            
            try {
                let query = db.collection(collectionPath);
                
                // Logique de tri optimis√©e : ajoute le second ordre de tri par d√©faut (date)
                if (currentSort === 'date') {
                    query = query.orderBy('timestamp', 'desc');
                } else if (currentSort === 'popularity') {
                    // S'assurer que 'totalReactions' existe dans Firestore. Il est incr√©ment√© dans handleReaction.
                    // Si deux messages ont le m√™me score de popularit√©, le plus r√©cent est affich√© en premier.
                    query = query.orderBy('totalReactions', 'desc').orderBy('timestamp', 'desc'); 
                }

                const snapshot = await query.get();

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-2xl text-gray-500 mt-16 font-display">Aucun message n\'a encore √©t√© enregistr√©. Soyez le premier !</p>';
                    countValue.textContent = '0';
                    return;
                }
                
                container.innerHTML = ''; 
                let count = 0;
                let delay = 0;
                const reactedIds = getReactedIds();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;
                    const formattedDate = formatDate(data.timestamp);
                    const reactions = data.reactions || { heart: 0, blessing: 0, star: 0 }; 
                    count++;
                    
                    const card = document.createElement('div');
                    card.className = 'testimonial-card animate-message';
                    card.style.animationDelay = `${delay}ms`; 
                    
                    const isReacted = reactedIds.has(docId);
                    const buttonStateClass = isReacted ? 'reacted' : '';
                    const buttonDisabledAttr = isReacted ? 'disabled' : '';

                    card.innerHTML = `
                        <p class="testimonial-name">T√©moignage de ${data.name || 'Anonyme'}</p>
                        
                        <p class="testimonial-message" aria-label="Message du fid√®le">¬´ ${data.message} ¬ª</p>
                        
                        <div class="no-print mt-8 pt-4 border-t border-gray-100 flex justify-between items-end">
                            <div class="flex space-x-4">
                                <button class="reaction-btn ${buttonStateClass}" data-reaction="heart" data-doc-id="${docId}" ${buttonDisabledAttr} aria-label="Aimer ce message">
                                    <span class="text-2xl">‚ù§Ô∏è</span>
                                    <span class="reaction-count">${reactions.heart || 0}</span>
                                </button>
                                <button class="reaction-btn ${buttonStateClass}" data-reaction="blessing" data-doc-id="${docId}" ${buttonDisabledAttr} aria-label="Envoyer une b√©n√©diction">
                                    <span class="text-2xl">üôè</span>
                                    <span class="reaction-count">${reactions.blessing || 0}</span>
                                </button>
                                <button class="reaction-btn ${buttonStateClass}" data-reaction="star" data-doc-id="${docId}" ${buttonDisabledAttr} aria-label="Marquer ce message d'une √©toile">
                                    <span class="text-2xl">üåü</span>
                                    <span class="reaction-count">${reactions.star || 0}</span>
                                </button>
                            </div>
                            
                            <div class="flex flex-col items-end">
                                <span class="testimonial-signature">${data.name || 'Anonyme'}</span>
                                <span class="testimonial-date">Publi√© le ${formattedDate}</span>
                            </div>
                        </div>
                        
                        <div class="only-print flex flex-col items-end pt-4">
                            <span class="testimonial-signature">${data.name || 'Anonyme'}</span>
                            <span class="testimonial-date">Publi√© le ${formattedDate}</span>
                        </div>
                    `;
                    container.appendChild(card);
                    
                    delay += 100;
                });

                countValue.textContent = count;
                
            } catch (error) {
                console.error("Erreur de chargement des messages:", error);
                container.innerHTML = `<div class="mt-16 p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg" role="alert"><p class="text-xl font-bold font-display">‚ùå Erreur de Connexion √† la base de donn√©es.</p><p class="mt-2">Veuillez v√©rifier vos r√®gles Firestore (allow read: true) et l'ID de projet.</p></div>`;
                countValue.textContent = 'Erreur';
            }
        };

        // Logique du Carrousel d'Images (Conserv√©e)
        let slideIndex = 0;
        
        const showSlides = () => {
            const slides = document.querySelectorAll('.carousel-slide');
            const totalSlides = slides.length;
            const carouselTrack = document.getElementById('carouselTrack');

            if (totalSlides === 0 || !carouselTrack) return;
            
            carouselTrack.style.transform = `translateX(${-slideIndex * 100}%)`;
        };

        const nextSlide = () => {
            const slides = document.querySelectorAll('.carousel-slide');
            const totalSlides = slides.length;
            if (totalSlides <= 1) return;

            slideIndex = (slideIndex + 1) % totalSlides; 
            showSlides();
        };

        // Chargement initial des messages et gestion des √©v√©nements
        document.addEventListener('DOMContentLoaded', () => {
            loadTestimonials(); 
            
            const totalSlides = document.querySelectorAll('.carousel-slide').length;
            if (totalSlides > 1) {
                showSlides();
                setInterval(nextSlide, 5000); 
            }

            // √âcouteur global pour les boutons de r√©action
            document.addEventListener('click', (e) => {
                const button = e.target.closest('.reaction-btn');
                if (button && !button.disabled) { 
                    const docId = button.dataset.docId;
                    const reactionType = button.dataset.reaction;
                    handleReaction(docId, reactionType, button);
                }
            });

            // √âcouteurs pour les boutons de tri
            const sortByDateButton = document.getElementById('sortByDate');
            const sortByPopularityButton = document.getElementById('sortByPopularity');

            const handleSortClick = (button, sortType) => {
                // D√©sactiver/Activer les classes 'active'
                sortByDateButton.classList.remove('active');
                sortByPopularityButton.classList.remove('active');
                button.classList.add('active');
                
                currentSort = sortType;
                loadTestimonials();
            };

            sortByDateButton.addEventListener('click', () => handleSortClick(sortByDateButton, 'date'));
            sortByPopularityButton.addEventListener('click', () => handleSortClick(sortByPopularityButton, 'popularity'));
        });
    </script>
</body>
</html>
